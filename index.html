<!DOCTYPE html>
<html>
<head>
  <title>Title</title>
  <meta charset="utf-8">
  <link rel="shortcut icon" href="resources/favicon.ico">
  <link rel="stylesheet" type="text/css" href="resources/light-theme.css" />
</head>
<body>
<textarea id="source">

---

## 準備

* ブラウザでスタートページにアクセス
    * [bit.ly/start-lagom-hands-on](http://bit.ly/start-lagom-hands-on)
    * 「ハンズオンを始める」に従って準備してください

---
class: center, middle
background-image: url("resources/img/title-background.jpg")

.glass[
# 変わりゆく要求に備えよ！<br>システムアーキテクチャの新常識<br>「マイクロサービス」<br>を作って体験しよう！
]

---

## 私は何者？

* 根来 和輝 .small[Negoro Kazuki]
* TIS株式会社 生産技術R＆D室
* Reactive System に関する技術検証・コンサル
    * Lightbend Reactive Platform
        * Akka / Play framework / Scala

.twitter-icon[[@negokaz](https://twitter.com/negokaz)] .github-icon[[negokaz](https://github.com/negokaz)]

???

* Reactive Platform の検証
    * Reactive System: 高レスポンス、耐障害性があり、スケーラブル なシステム
    * Typesafe がメインで作っている Reactive System を実現するためのフレームワークやライブラリ
    * SI でどのようにすれば活用できるか？

---

## マイクロサービスアーキテクチャってなに？

* 2014年3月に ThoughtWorks の Martin Fowler によって提唱された
* 小さいサービスを組み合わせて一つのアプリケーションを構築するスタイルのこと
* サービスどうしを疎結合にすることにより様々な利点が得られる

???

In short, the microservice architectural style is an approach to developing
a single application as a suite of small services, each running in its own process
and communicating with lightweight mechanisms, often an HTTP resource API.
These services are built around business capabilities and
independently deployable by fully automated deployment machinery.
There is a bare minimum of centralized management of these services,
which may be written in different programming languages and use different data storage technologies.
http://martinfowler.com/articles/microservices.html

---

## マイクロサービスアーキテクチャの主な利点

* サービスごとに異なる技術を使うことができる
  * サービスの特性に合った技術を採用することができる
* レジリエンス(回復性)が得られる
  * サービスの一部に障害が起きても全体としては稼働し続ける
  * すぐ障害の原因を取り除けばユーザーからは何事も無かったかのように見える
* サービスごとにスケーリングできる
  * 細かい粒度でスケーリングできるためコスト効率がよくなる
* デプロイの影響範囲を小さくすることができる
  * 新機能や修正を迅速にリリースすることができるようになる

---

## マイクロサービスアーキテクチャのトピックス

* アプリケーション設計
* インフラストラクチャ
* (人の)組織
* システム運用
* セキュリティ

---

## 今日やること・やらないこと

* **アプリケーション設計**
* ~~インフラストラクチャ~~
* ~~(人の)組織~~
* ~~システム運用~~
* ~~セキュリティ~~

---

## 今日やること

* マイクロサービス向けのフレームワーク Lagom から、アプリケーション設計に関わるプラクティスを学び取る

---

## Lagom とは？

* 米Lightbend社が3月にリリースしたマイクロサービス向けフレームワーク
* **Reactive** Microservices Architecture をコアコンセプトとしている
* [https://www.lightbend.com/lagom](https://www.lightbend.com/lagom)

???
https://www.lightbend.com/company/news/lagom-a-new-microservices-framework
http://www.oreilly.com/programming/free/reactive-microservices-architecture.html

---

## Lagom の特徴的な設計思想

* サービス内部で使うAPIは全て非同期API
* 分散型の永続化機構
  * CQRS
  * Event Sourcing

---

# ハンズオン

TODO:
* アプリの概要説明・構成
* プロジェクト構造

* 外部サービスとのコミュニケーション

---

## Serialization

* Lagom では同期呼び出しと非同期呼び出しがサポートされている
* 同期呼び出し - HTTP
* 非同期呼び出し - WebSocket
* フォーマットはJSONがデフォルトでサポートされている

---

## Hands-on 1 - Lagom のAPIを叩いてみる

[Advanced REST Client を起動](https://chrome.google.com/webstore/detail/advanced-rest-client/hgmloofddffdnphfgcellkdfbfbjeloo/)

.height-2.with-cursor[
![](resources/img/chrome-app-launch.png)
]

### HTTP

### HTTPS

---

## イベントソーシングとCQRS

---

## イベントソーシング

* システムの中で起きた**イベント**を永続化する
* イベントは不変(immutable)
    * キャッシュ、コピー、共有が容易にできる
    * ⇒ スケールしやすくなる
* デメリットは、データを集計するような場合大変
* ⇒ CQRSで回避できる

---

## CQRS

* **C**ommand and **Q**uery **R**esponsibility **S**egregation <br />

    コマンドクエリ責務分離

* コマンド(書き込み)とクエリ(読み込み)を分離する
* 書き込み側と読み込み側で
    * 異なるDB、データ構造を採用することができるようになる
    * 別々にスケールできるようになる
* 書き込み側にイベントソーシングを使い、読み込み側にクエリしやすい形で保存できる
* デメリットは、読み込み側と書き込み側で完全な一貫性を保てなること

---

## 最終的に目指す形

---

## Hands-on 2 - Write-Side の実装

1. FavoriteEntity を実装する
2. FavoriteServiceImpl から FavoriteEntity にコマンドを送る

## 確認

* お気に入りが永続化できている

---

## Hands-on 3 - Read-Side の実装

1. FavoriteEventProcessor を実装する
2. FavoriteServiceImpl からクエリする

## 確認

* お気に入りのカウントが見えるようになる
* ただし、若干のタイムラグがある

---

## CircuitBreaker とは？

* open-close-halfopen
* 障害を波及させない
* リクエスト爆発を起こさない

---

### Hands-on 4 - CircitBreaker の実装

1. FavoriteService に CircitBreaker を定義する

※ CircitBreaker は呼び出し側の制御。
Lagom外からHTTPなどでリクエストを投げる場合は注意

---

## まとめ

* マイクロサービスアーキテクチャで犠牲になること
  * 結果整合性
    * サービスをまたがるトランザクションを作らない
    * サービスをまたがる場合は Saga を検討する

---

## 参考資料

* [マイクロサービスアーキテクチャ]()

???

TODO: なぜ全部非同期なのか？

</textarea>
  <script src="resources/remark-0.13.0.min.js"></script>
  <script>
    var slideshow = remark.create();
  </script>
</body>
</html>
